# `GCC4.4.0`æºç å‰–æ

- â­ï¸ï¼šå·¥ç¨‹å®è·µç»éªŒ
- âœ”ï¸ï¼šå·²å®Œæˆ
- é…åˆæ•™æï¼šã€Šæ·±å…¥åˆ†æGCCã€‹

```txt
<font style="background:yellow">
```





## ç›®å½•

[TOC]







## âœ”ï¸A1.ç¯å¢ƒé…ç½®

### 1.1.æºä»£ç ä¸‹è½½

- ä¸‹è½½æºä»£ç 

```bash
[root@CentosLinux ~]# wget -c http://mirror1.babylon.network/gcc/releases/gcc-4.4.0/gcc-4.4.0.tar.bz2
--2021-11-26 10:56:01--  http://mirror1.babylon.network/gcc/releases/gcc-4.4.0/gcc-4.4.0.tar.bz2
Resolving mirror1.babylon.network (mirror1.babylon.network)... failed: Name or service not known.
wget: unable to resolve host address â€˜mirror1.babylon.networkâ€™
```

- å‘ç°ä¸è¡Œï¼Œç”¨ä¸‹é¢

```bash
wget -c https://ftp.gnu.org/gnu/gcc/gcc-4.4.0/gcc-4.4.0.tar.bz2
```

- è§£å‹ç¼©

```bash
tar xjvf gcc-4.4.0.tar.bz2
```



### 1.2.GCCæºç ç¼–è¯‘â­ï¸

- Linux From Scratchï¼šhttp://www.jinbuguo.com/lfs/lfs62/index.html
- [GCCæºç ç¼–è¯‘](https://www.cnblogs.com/alianbog/p/12498915.html)



#### 1.2.1.ä¸‹è½½ä¾èµ–

Gcc çš„ä¸‰å¤§ä»¶å‰é¢å·²ç»æåˆ°è¿‡äº†ï¼Œè€Œå®ƒä»¬åœ¨å®‰è£…æ—¶ä¹Ÿå­˜åœ¨ä¾èµ–å…³ç³»

- mpfr éœ€è¦ä¾èµ– gmpï¼Œmpc åˆ™æ˜¯ä¾èµ– gmp å’Œ mpfrï¼Œå› æ­¤å®‰è£…çš„é¡ºåºæ˜¯ gmpï¼Œmpfrï¼Œæœ€åæ‰æ˜¯ mpcã€‚
- ä¾èµ–å…³ç³»å‚è€ƒæ•™ç¨‹ï¼šhttps://jcf94.com/2016/04/15/2016-04-15-gcc/

```mermaid
graph LR
gmp-->mpfr-->mpc
gmp-->mpc
```

gmpï¼ˆå…¬å¸æœ‰ç±»ä¼¼çš„ï¼‰

- GMP(The GNU Multiple Precision Arithmetic Library)åˆå«**GNUå¤šç²¾åº¦ç®—æœ¯åº“**ï¼Œæ˜¯ä¸€ä¸ªæä¾›äº†å¾ˆå¤šæ“ä½œé«˜ç²¾åº¦çš„å¤§æ•´æ•°ï¼Œæµ®ç‚¹æ•°çš„è¿ç®—çš„ç®—æœ¯åº“ï¼Œå‡ ä¹æ²¡æœ‰ä»€ä¹ˆç²¾åº¦æ–¹é¢çš„é™åˆ¶ï¼ŒåŠŸèƒ½ä¸°å¯Œã€‚æˆ‘åˆšæ¥è§¦åˆ°è¿™ä¸ªä¸œè¥¿çš„æ—¶å€™æ˜¯åœ¨å­¦ä¹ PHPçš„è¿‡ç¨‹ä¸­ã€‚GMPçš„ä¸»è¦ç›®æ ‡åº”ç”¨é¢†åŸŸæ˜¯å¯†ç å­¦çš„åº”ç”¨å’Œç ”ç©¶ã€ äº’è”ç½‘å®‰å…¨åº”ç”¨ã€ ä»£æ•°ç³»ç»Ÿã€ è®¡ç®—ä»£æ•°ç ”ç©¶ç­‰ã€‚
- å‚è€ƒèµ„æ–™ï¼šhttps://www.cnblogs.com/ECJTUACM-873284962/p/8350320.html

mpfr

- MPFRï¼šGNUå¤šç²¾åº¦æµ®ç‚¹èˆå…¥åº“
- å®˜ç½‘ï¼šhttps://www.mpfr.org/

mpc

- MPCï¼šGNUå¤šç²¾åº¦Cåº“
- https://ftp.gnu.org/gnu/mpc/



#### 1.2.2.æ‰©å±•çš„

- ELFï¼šå¯æ‰§è¡Œå’Œå¯é“¾æ¥æ ¼å¼åº“
- PPLï¼šParma Polyhedraåº“ï¼ˆPPLéå¿…éœ€ï¼‰ï¼ˆå¯é€‰ï¼Œç”¨äºå†…å­˜ä¼˜åŒ–ï¼‰
- islåº“ï¼šï¼ˆISLéå¿…éœ€ï¼‰ï¼šislæ˜¯ä¸€ä¸ªç”¨äºå¤šé¢ä½“æ¨¡å‹è°ƒåº¦å®ç°çš„c/c++åº“ã€‚é€šè¿‡islï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¨¡å‹è¿›è¡Œè‡ªåŠ¨çš„è°ƒåº¦ï¼Œå¾ªç¯ä¼˜åŒ–ç­‰ã€‚
- expatï¼šExpatæ˜¯ä¸€ä¸ªç”¨Cè¯­è¨€å¼€å‘çš„ã€ç”¨æ¥è§£æXMLæ–‡æ¡£çš„å¼€å‘åº“ï¼Œå®ƒæœ€åˆæ˜¯å¼€æºçš„ã€Mozilla é¡¹ç›®ä¸‹çš„ä¸€ä¸ª[XMLè§£æå™¨](https://baike.baidu.com/item/XMLè§£æå™¨/2673664)ã€‚
- libiconvåº“ï¼šlibiconvåº“æ˜¯ä¸€ä¸ªåŸºäºGNUåè®®çš„å¼€æºåº“ï¼Œä¸»è¦æ˜¯è§£å†³å¤šè¯­è¨€ç¼–ç å¤„ç†è½¬æ¢ç­‰åº”ç”¨é—®é¢˜ç”±äºå†å²åŸå› ï¼Œå›½é™…åŒ–çš„æ–‡å­—å¸¸å¸¸ç”±äºè¯­è¨€æˆ–è€…å›½å®¶çš„åŸå› ä½¿ç”¨ä¸åŒçš„ç¼–ç ã€‚Libiconvæ˜¯ä¸€ä¸ªå¸¸ç”¨çš„ç¼–ç è½¬æ¢åº“ï¼Œæ”¯æŒå¸¸ç”¨çš„å¤šç§ç¼–ç ä¹‹é—´çš„è½¬æ¢ï¼Œä¸»è¦å‡½æ•°æœ‰ï¼š
- dejagnuåº“ï¼šDejaGnu æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„å¼€æºçš„æµ‹è¯•å·¥å…·ï¼Œå°¤å…¶æ˜¯åš GNU å¼€æºå·¥å…·é“¾çš„è½¯ä»¶å¼€å‘ï¼Œæ›´ç¦»ä¸å¼€ DejaGnu çš„æ”¯æŒï¼Œå› ä¸º binutils, gcc, gdb è‡ªå¸¦çš„[**æµ‹è¯•ç”¨ä¾‹**](javascript:;)éƒ½æ˜¯ä½¿ç”¨ DejaGnu è¿›è¡Œæµ‹è¯•çš„ã€‚ä½†æ˜¯ï¼ŒDejaGnu ä¹Ÿæœ‰ä¸€äº›ä¸è¶³ä¹‹å¤„ã€‚å› ä¸ºå®ƒæ˜¯å¼€æºçš„ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹å®ƒæ¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚
- riscv-isa-simï¼šriscv-isa-simæ˜¯ä¸€ä¸ªRISC-VæŒ‡ä»¤çš„ä»¿çœŸå™¨ï¼Œriscv-isa-simçš„æ­£å¸¸è¿è¡Œéœ€è¦ä¾èµ–**riscv-pk**å’Œriscv-fesvrå·¥å…·ã€‚å‰é¢æœ‰å¯¹è¿™äº›å·¥å…·çš„è¯´æ˜ã€‚riscv-isa-simç¼–è¯‘åä¸»è¦ç”¨åˆ°çš„å·¥å…·æ˜¯spikeã€‚å…¶å®spikeä¸å•å•å¯ä»¥ä»¿çœŸRISC-VæŒ‡ä»¤çš„ï¼Œè¿˜èƒ½ä»¿çœŸLinuxç³»ç»Ÿã€‚



### ç¼–è¯‘æ–¹æ³•1.2022.gcc.11.2

```bash
whoway@ubuntu:~/gcc$ cd contrib/
whoway@ubuntu:~/gcc/contrib$ bash download_prerequisites 
error: You must run this script in the top-level GCC source directory
whoway@ubuntu:~/gcc/contrib$ cd ..
whoway@ubuntu:~/gcc$ pwd
whoway@ubuntu:~/gcc$ bash contrib/download_prerequisites 
2022-02-14 17:01:33 URL:http://gcc.gnu.org/pub/gcc/infrastructure/gmp-6.2.1.tar.bz2 [2493916/2493916] -> "gmp-6.2.1.tar.bz2" [1]
2022-02-14 17:03:25 URL:http://gcc.gnu.org/pub/gcc/infrastructure/mpfr-4.1.0.tar.bz2 [1747243/1747243] -> "mpfr-4.1.0.tar.bz2" [1]
2022-02-14 17:04:06 URL:http://gcc.gnu.org/pub/gcc/infrastructure/mpc-1.2.1.tar.gz [838731/838731] -> "mpc-1.2.1.tar.gz" [1]
2022-02-14 17:05:39 URL:http://gcc.gnu.org/pub/gcc/infrastructure/isl-0.24.tar.bz2 [2261594/2261594] -> "isl-0.24.tar.bz2" [1]
gmp-6.2.1.tar.bz2: OK
mpfr-4.1.0.tar.bz2: OK
mpc-1.2.1.tar.gz: OK
isl-0.24.tar.bz2: OK
All prerequisites downloaded successfully.

whoway@ubuntu:~/gcc$ mkdir gcc-build-2022
whoway@ubuntu:~/gcc$ cd gcc-build-2022/
whoway@ubuntu:~/gcc/gcc-build-2022$ ../gcc
gcc/            gcc-build-2022/ 
whoway@ubuntu:~/gcc/gcc-build-2022$ ../gcc
gcc/            gcc-build-2022/ 
whoway@ubuntu:~/gcc/gcc-build-2022$ ../gcc/config
config/    configure  
whoway@ubuntu:~/gcc/gcc-build-2022$ ../gcc/config
config/    configure  
whoway@ubuntu:~/gcc/gcc-build-2022$ ../gcc/configure --prefix=/usr --enable-multilib --enable-languages=c,c++ -disable-multilib


....
mkdir -p -- c-family/.deps
mkdir -p -- common/.deps
mkdir -p -- analyzer/.deps
mkdir -p -- rtl-ssa/.deps
config.status: executing default commands
```



## âœ”ï¸A2.GCCçš„referenceé“¾æ¥

> gccç›¸å…³æ–‡æ¡£

- gccçš„å®˜æ–¹Wikiï¼š[https://gcc.gnu.org/wiki/](https://gcc.gnu.org/wiki/)

- GCC online documentationï¼ˆå®ç°ï¼‰ï¼š[https://gcc.gnu.org/onlinedocs/](https://gcc.gnu.org/onlinedocs/)

  - ä½†æ˜¯æ²¡æœ‰å„ä¸ªç‰ˆæœ¬çš„inter

- æºç ä¸‹è½½ftpï¼š[https://ftp.gnu.org/gnu/gcc/gcc-4.1.0/](https://ftp.gnu.org/gnu/gcc/gcc-4.1.0/)

- releaseï¼š[https://gcc.gnu.org/releases.html](https://gcc.gnu.org/releases.html)

  - 0.5.`GCC 4.1` Release Seriesã€å‘å¸ƒç³»åˆ—ã€

  - Release History

    - GCC 4.1.2

      February 13, 2007 ([changes](https://gcc.gnu.org/gcc-4.1/changes.html#4.1.2))

    - GCC 4.1.1

      May 24, 2006 ([changes](https://gcc.gnu.org/gcc-4.1/changes.html))

    - GCC 4.1.0

      February 28, 2006 ([changes](https://gcc.gnu.org/gcc-4.1/changes.html))

> æŸæ¬¡ä¼˜åŒ–ç‚¹

1.è®ºæ–‡å®ç°çš„ç½‘ç«™

- [https://gcc.gnu.org/projects/cfo.html](https://gcc.gnu.org/projects/cfo.html)

2.GCC: Anonymous read-only Git access

- æåˆ°äº†cfo-branch
- [https://gcc.gnu.org/git.html](https://gcc.gnu.org/git.html)





## âœ”ï¸A3.å·¥å…·å‡†å¤‡

### 3.1.é…ç½®vim+ctagsä»£ç é˜…è¯»

- å®‰è£…ctags

```bash
sudo yum install ctags

ctags --version
```

> å…¬å¸çš„Ubuntué‡åˆ°çš„æƒ…å†µctags

```bash
XX@XXXX:~$ ctags --version

Command 'ctags' not found, but can be installed with:

apt install exuberant-ctags  # version 1:5.9~svn20110310-12, or
apt install universal-ctags  # version 0+git20181215-2

Ask your administrator to install one of them.

XX@XXXX:~$ apt install exuberant-ctags  # version 1:5.9~svn20110310-12, or
on 0+git20181215-2E: Could not open lock file /var/lib/dpkg/lock-frontend - open (13: Permission denied)
E: Unable to acquire the dpkg frontend lock (/var/lib/dpkg/lock-frontend), are you root?
```

- è¿è¡Œ

```bash
cd gcc-4.4.0/
ctags -R
ll -rt
-rw-r--r--  1 root root 52363468 Nov 26 11:10 tags
ls -l tags
```

- è¿˜å¯ä»¥å°è¯•SourceInsightå’ŒVScode



### 3.2.è°ƒè¯•å·¥å…·`gdb`â­ï¸

- å†…éƒ¨å‘½ä»¤ä½¿ç”¨ã€Œç»„ä¼šä¸­å­¦åˆ°çš„ã€
- gdbå‘½ä»¤å·¥å…·ç½‘ç«™ï¼š[https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/gdb.html](https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/gdb.html)

```bash
si	#å•æ¡æŒ‡ä»¤æ‰§è¡Œ
layout prev
layout asm	#æ˜¾ç¤ºåæ±‡ç¼–çª—å£
layout regs	#æ˜¾ç¤ºæºä»£ç /åæ±‡ç¼–å’ŒCPUå¯„å­˜å™¨çª—å£
layout previous
disable
remote tagert:ç«¯å£å·	#ç¬¬1æ¬¡çœ‹åˆ°ï¼Œè¿™æ ·å’Œqemuè”åˆè°ƒè¯•
```



### 3.3.GNU binutilså·¥å…·é›†

- objdump
- ld
- nm

### 3.4.Shellçš„3ä¸ªå·¥å…·-grepã€sedã€awk



### 3.5.å›¾å½¢åŒ–çš„Linuxçš„graphvizå·¥å…·

- å¯è§†åŒ– treeï¼ŒRTL æ§åˆ¶æµå›¾wiki
- å‚è€ƒè‡ª@[abrasumente233](https://github.com/abrasumente233)ã€Œä½•çºªå®ã€

å½“ç¨‹åºæ§åˆ¶æµæ¯”è¾ƒå¤æ‚æ—¶ï¼Œgcc dump å‡ºæ¥çš„æ–‡æœ¬ IR ä¼šååˆ†ç¹çéš¾è¯»ï¼Œä» `gcc 4.8.2` å¼€å§‹æ–°å¢äº†ä¸¤ä¸ªé€‰é¡¹ï¼Œ

- `-fdump-tree-all-graph` å’Œ `fdump-rtl-all-graph`ï¼Œå¯ä»¥æŠŠæ¯ä¸ªpassåçš„ tree æˆ– rtl ä»¥ dot æ–‡ä»¶æ ¼å¼å¯¼å‡ºï¼ŒåŠ ä»¥ dot æ¸²æŸ“å™¨è½¬åŒ–æˆ png å¾—åˆ°å›¾å½¢åŒ–çš„ IR dumpã€‚

å¦‚ï¼š

```c
// vis.c

void visualize(int x) {
    if (x) {
        return 1;
    } else {
        return 2;
    }
}

```

- å‘½ä»¤è¡Œ

```bash
$ gcc vis.c -S -fdump-tree-all-graph -fdump-rtl-all-graph
$ dot -Tpng vis.c.019t.ssa.dot > ssa.png
$ dot -Tpng vis.c.241r.cprop1.dot > cprop.png
```

æ•ˆæœå¦‚ä¸‹ï¼š

æœ€åé™„èµ ä¸€ä¸ªæŠŠå½“å‰ç›®å½•ä¸‹ dot æ–‡ä»¶å…¨è½¬åŒ–æˆ png çš„è„šæœ¬

```bash
#!/bin/bash
for DOT in *.dot
do
    echo ${DOT%.*}.png
    dot -Tpng $DOT > ${DOT%.*}.png &
done
```

### 3.6.â­ï¸GCCè°ƒè¯•é€‰é¡¹ã€Œæ ¸å¿ƒã€

```bash
gcc -fdump-tree-all test.c
gcc -fdump-rtl-all test.c	#ç”Ÿæˆrtl
```

**ç”Ÿæˆdot**

```bash
riscv32-unknown-elf-gcc -S -c -fdump-tree-all-graph test.c -o temp
ls
riscv32-unknown-elf-gcc -S -c -fdump-rtl-all-graph test.c -o temp
ls
```







## âœ”ï¸A4.å·¥ç¨‹æŠ€å·§

### 4.1.å¢é‡ç¼–è¯‘

- åœ¨libgccåº“é‡Œé¢ï¼Œæ‰€ä»¥åœ¨ç¼–gccçš„æ—¶å€™è¦**åŠ ä¸Šé€‰é¡¹**ï¼ˆå®æ§åˆ¶çš„ç¼–è¯‘ï¼‰

```bash
./build_toolchain.sh update "-femit-clz -DENABLE_CTZ"
```

- æˆ–è®¸ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œ`-g`çš„å¢é‡ç¼–è¯‘ï¼Ÿ

### 4.2.è¾…åŠ©çœ‹gccæºç ç½‘ç«™

- [https://code.woboq.org/](https://code.woboq.org/)



## âœ”ï¸A5.GCC.11.1.0çš„ç¼–è¯‘riscvç‰ˆ

```bash
wget https://ftp.gnu.org/gnu/binutils/binutils-2.37.tar.gz
git clone https://github.com/gcc-mirror/gcc
wget ftp://sourceware.org/pub/newlib/newlib-4.1.0.tar.gz
```

> æ–°å»ºä¸€ä¸ªå®‰è£…æ–‡ä»¶å¤¹ï¼š
>
> - `mkdir /home/whoway/11.1.0/2022before/second/789410Second`

### 1.ç¼–è¯‘ binutils

- è§£å‹ç¼©åï¼Œè¿›å…¥binutils

```bash
mkdir binutils-build && cd binutils-build	

../configure --target=riscv32-unknown-elf --prefix=/home/whoway/11.1.0/2022before/second/789410Second --disable-werr

make -j15 && make install
```

- å…³äºBinutilsç¼–è¯‘è¿‡ç¨‹ä¸­å‡ºç°werrorçš„è§£å†³åŠæ³•ï¼Œå¦‚æœåœ¨ç¼–è¯‘binutilsæºç è¿‡ç¨‹ä¸­å‡ºç°ç±»ä¼¼ä»¥ä¸‹æŠ¥é”™å¯ä»¥å…ˆå°è¯•åœ¨configureçš„æ—¶å€™åŠ ä¸Š--disable-werror
- make ç¼–è¯‘ linux å†…æ ¸æ˜¯å•çº¿ç¨‹çš„ä»»åŠ¡ é‡‡ç”¨`-j4`å‘½ä»¤ä½¿ç”¨4 çº¿ç¨‹åŠ é€Ÿï¼Œä»Šå¤©ä½¿ç”¨ make ç¼–è¯‘ linux å†…æ ¸ï¼Œå‘ç°CPUåªç”¨äº†30%å¤šä¸€ç‚¹ï¼Œè€Œæˆ‘çš„ç”µè„‘æ˜¯4æ ¸çš„ï¼Œæ‰€ä»¥å¦‚æœæ²¡æœ‰æ„å¤–çš„è¯ï¼Œmake ç¼–è¯‘ linux å†…æ ¸çš„ä»»åŠ¡æ˜¯ç”¨å•çº¿ç¨‹åšçš„ã€‚åˆäº†è§£åˆ°ï¼Œä½¿ç”¨-j4å‚æ•°å¯ä»¥ä½¿ç”¨4ä¸ªçº¿ç¨‹æ›´é«˜æ•ˆçš„å®Œæˆç¼–è¯‘å·¥ä½œã€‚



### 2.ç¼–è¯‘ GCC

- å…ˆ`cd gcc`è¿›å»

- ç„¶åï¼Œå®‰è£…å‰ç½®ä¾èµ–ï¼Œè¿™æ ·æ‰§è¡Œ`./contrib/download_prerequisites`
- ç„¶åæ‰§è¡Œä¸‹é¢ï¼š

```bash
mkdir gcc-build && cd gcc-build

../configure --target=riscv32-unknown-elf --prefix=/home/whoway/11.1.0/2022before/second/789410Second --with-abi=ilp32 --with-arch=rv32ic --enable-languages=c,c++

make all-gcc all-target-libgcc -j15

make install-gcc install-target-libgcc
```

- --with-abi=ilp32ï¼š å·¥å…·é“¾æ”¯æŒçš„abiæ–¹å¼æ˜¯ilp64
- --with-arch=rv32imc: å·¥å…·é“¾æ”¯æŒçš„riscvæ¶æ„æ˜¯ rv64imc
- --enable-languages=c,c++

### 3.ç¼–è¯‘ newlib

- è§£å‹ç¼©åï¼Œè¿›å…¥newlib

```bash
mkdir newlib-build && cd newlib-build

../configure --target=riscv32-unknown-elf -disable-nls --enable-newlib-io-long-long --enable-newlib-io-long-double --enable-newlib-io-c99-formats --disable-libssp --prefix=/home/whoway/11.1.0/2022before/second/789410Second

make -j15 && make install
```

- è‡³æ­¤ï¼Œå®Œæˆäº†ç¼–è¯‘ï¼Œå¯ä»¥å»æ–‡ä»¶å¤¹/binå»ç”¨äº†





## 1-3.åŸºç¡€çŸ¥è¯†



### 1.1.GCCçš„é€»è¾‘ç»“æ„

![20211005170914](https://cdn.jsdelivr.net/gh/HACV/picture/img/20211005171001.png)



### 1.2.é…ç½®æœ¯è¯­

::: tip æç¤º

- æ„å»ºæ—¶æ‰€ä½¿ç”¨çš„æœºå™¨ï¼ˆbuildï¼‰
- æ„å»ºå®Œæˆåå°†ä½¿ç”¨çš„æœºå™¨ï¼ˆhostï¼‰
- GCCæœªæ¥ç”Ÿæˆä»£ç æ‰€è¦è¿è¡Œçš„æœºå™¨ï¼ˆtargetï¼‰

:::

> è¦é¿å…åªæŒ‡å®šhostè€Œä¸æŒ‡å®šbuildï¼Œå› ä¸º configure ç¨‹åºå¯èƒ½ä¼šè®¤ä¸º ä½ æ‰€æŒ‡å®šçš„hostå’Œbuildç›¸åŒ
> ï¼ˆæ›¾ç»å‘ç”Ÿè¿‡ï¼‰ï¼Œè€Œå®é™…ä¸Šå¯èƒ½å¹¶éå¦‚æ­¤

- ï¼ˆ1ï¼‰build, hostå’Œtargetéƒ½ç›¸åŒçš„æƒ…å†µå«åš nativeï¼ˆ**æœ¬åœ°çš„**ï¼‰
- ï¼ˆ2ï¼‰build, hostå’Œtargetéƒ½ä¸åŒçš„æƒ…å†µåˆ™è¢«ç§°ä¸ºcanadian ï¼ˆ**åŠ æ‹¿å¤§çš„**ï¼Œç”¨æ¥æš—æŒ‡åŠ æ‹¿å¤§æ”¿å…šçŠ¶å†µä¸å½“æ—¶ä»äº‹æ„å»ºå·¥ä½œçš„äººçš„èƒŒæ™¯ç±»ä¼¼ï¼‰

> ä¸‹é¢æ˜¯C(3,2)ç§

- ï¼ˆ3ï¼‰buildå’Œhostç›¸åŒï¼Œä½†targetä¸åŒï¼Œå°±å«åš crossï¼ˆ**äº¤å‰çš„**ï¼‰
- ï¼ˆ4ï¼‰å¦‚æœhostå’Œ targetç›¸åŒï¼Œ ä½†buildä¸åŒï¼Œåˆ™è¡¨æ˜ä½ åœ¨ä½¿ç”¨äº¤å‰ç¼–è¯‘å™¨æ¥ä¸ºä¸€ä¸ªä¸åŒçš„ç³»ç»Ÿæ„å»ºæœ¬åœ°ç¼–è¯‘å™¨æœ‰äº›äººæŠŠè¿™ç§°ä¸º host-x-hostï¼Œcrossed nativeï¼ˆäº¤å‰çš„æœ¬åœ°çš„ï¼‰ï¼Œ æˆ– cross-built native(äº¤å‰æ„å»ºçš„æœ¬åœ°çš„ï¼‰
- ï¼ˆ5ï¼‰å¦‚æœbuildå’Œtargetç›¸åŒï¼Œ ä½†hostä¸åŒï¼Œåˆ™è¡¨æ˜ä½ åœ¨ä½¿ç”¨äº¤å‰ç¼–è¯‘å™¨æ¥æ„å»ºä¸€ä¸ªäº§ç”Ÿæ„å»ºæ—¶æ‰€åœ¨æœºå™¨ä»£ç çš„ äº¤å‰ç¼–è¯‘å™¨ã€‚è¿™ç§æƒ…å†µå¾ˆå°‘è§ï¼Œæ‰€ä»¥æ²¡æœ‰é€šç”¨çš„æ–¹å¼æ¥æè¿°å®ƒã€‚æœ‰äººå»ºè®®ç§°ä¹‹ä¸º crossback





## 4.ä»æºä»£ç åˆ°AST/GENERIC

è¯­æ³•åˆ†æ

è¯­è¨€å‰ç«¯åªè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œé€šè¿‡lang hooks.parse fileï¼Œ ç”¨æ¥è§£ææ•´ä¸ªè¾“å…¥ã€‚è¯­è¨€å‰ç«¯å¯ä»¥ä½¿ç”¨ä»»ä½•è¢«è®¤ä¸ºåˆé€‚çš„ä¸­é—´è¯­è¨€è¡¨ç¤ºã€‚ Cå‰ç«¯ä½¿ç”¨äº†GENERICæ ‘ï¼Œ Fortranå‰ç«¯ä½¿ç”¨äº†å®Œå…¨ä¸åŒçš„ç§æœ‰è¡¨ç¤ºã€‚

åœ¨æŸä¸ªåœ°æ–¹ï¼Œ å‰ç«¯å¿…é¡»å°†å…¶ä½¿ç”¨çš„è¡¨ç¤ºè½¬æ¢ä¸ºç¼–è¯‘å™¨ä¸­è¯­è¨€ç‹¬ç«‹çš„éƒ¨åˆ†èƒ½å¤Ÿç†è§£çš„è¡¨ç¤ºã€‚ ç›®å‰çš„
å®ç°é‡‡ç”¨äº†ä¸¤ç§å½¢å¼ã€‚

- 1.Cå‰ç«¯åœ¨å‡½æ•°ç¼–è¯‘å®Œä¹‹å‰ï¼Œ æ‰‹åŠ¨çš„å¯¹æ¯ä¸ªå‡½æ•°è°ƒç”¨gimplifierï¼Œ å¹¶ä¸”ä½¿ç”¨gimplifierå›è°ƒå‡½æ•°å°†è¯­è¨€ç‰¹å®šçš„æ ‘ä»£ç ç›´æ¥è½¬æ¢ä¸ºGIMPLE
- 2.Fortranå‰ç«¯å°†ç§æœ‰è¡¨ç¤ºè½¬æ¢ä¸ºGENERICï¼Œä¹‹åå½“å‡½æ•°ç¼–è¯‘å®Œæ—¶ï¼Œ å†é™ä½ä¸ºGIMPLEã€‚



## 5.ä»AST/GENERICåˆ°GIMPLE



## 6.GIMPLEå¤„ç†åŠå…¶ä¼˜åŒ–



## 7.RTL

## âœ”ï¸RTLåŠ é¤

Gimpleåˆ°RTLï¼ˆè½¬æ¢)

- RTLæŒ‰ç…§ä½œç”¨åˆ†ï¼š
  - 1.`IR-RTL`ï¼ˆä¹Ÿå°±æ˜¯ç”Ÿæˆçš„`insn`ã€ä¹Ÿå°±æ˜¯æˆ‘ä»¬åšâ€œ`peephole2`â€ä¼˜åŒ–æ—¶å€™ï¼Œçœ‹çš„`-fdump-rtl-peephole2`ä¸­çš„é‚£äº›insnå•¥å•¥å•¥çš„ï¼‰
  - 2.`MD-RTL`ï¼ˆä¹Ÿå°±æ˜¯`riscv.md`ä¸­å†™çš„é‚£ç§ï¼‰





## 8.æœºå™¨æè¿°æ–‡ä»¶{target}.md



## 9.æœºå™¨æè¿°æ–‡ä»¶S{target}.[ch]







## 10.ä»Gimpleåˆ°RTL

### 10.1.Gimpleåºåˆ—

- é’ˆå¯¹Gimpleçš„æœ€å1ä¸ªå…³é”®çš„â€œå¤„ç†è¿‡ç¨‹â€ä¸º`pass_expand`ï¼Œè¯¥Passå°±å®Œæˆäº†Gimpleå‘RTLçš„è½¬æ¢ã€‚
  - å³ç”±Gimpleä¸­é—´ç»“æœç”ŸæˆRTLå½¢å¼çš„insn



### 10.2.å…¸å‹æ•°æ®ç»“æ„

- ä»¥â€œ**å‡½æ•°**â€ä¸º**å•ä½**è¿›è¡ŒRTLç”Ÿæˆæ—¶ï¼Œéœ€è¦å¯¹**å½“å‰å‡½æ•°**çš„**RTLä¿¡æ¯**è¿›è¡Œç»´æŠ¤
  - è¿™ä¸ªä¸»è¦ç”±ç»“æ„ä½“`struct rtl_data`æ¥æè¿°
  - åœ¨`gcc/function.h`ä¸­å®šä¹‰
- åœ¨`gcc/emit-rtl.c`ä¸­å®šä¹‰äº†å¦‚ä¸‹çš„å®ï¼Œç”¨æ¥è®¿é—®**å½“å‰å‡½æ•°**æ­£åœ¨å¤„ç†çš„insnåºåˆ—

```c
#define first_insn (crtl->emit.x_first_insn)
#define last_insn (crtl->emit.x_last_insn)
#define cur_insn_uid (crtl->emit.x_cur_insn_uid)
```

### 10.3.RTLç”Ÿæˆçš„åŸºæœ¬è¿‡ç¨‹

- 1.å˜é‡å±•å¼€ï¼š

  - è°ƒç”¨`expand_used_vars(void)`å‡½æ•°ï¼Œå¯¹å½“å‰å‡½æ•°ä¸­æ‰€æœ‰çš„å˜é‡è¿›è¡Œåˆ†æ
  - åœ¨è™šæ‹Ÿå¯„å­˜å™¨æˆ–è€…å †æ ˆä¸­ä¸ºå…¶åˆ†é…ç©ºé—´ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„RTX

- 2.å‚æ•°å’Œè¿”å›å€¼çš„å¤„ç†ï¼š

  - è°ƒç”¨`expand_function_start( current_function_decl )`å‡½æ•°
  - å¯¹å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼è¿›è¡Œå¤„ç†ï¼Œç”Ÿæˆå…¶å¯¹åº”çš„RTX

- 3.**åˆå§‹åŒ–å—**çš„å¤„ç†ï¼š

  - è°ƒç”¨`construt_init_block(void)`å‡½æ•°ï¼Œåˆ›å»ºåˆå§‹åŒ–å—
  - å¹¶ä¿®æ­£å‡½æ•°çš„æ§åˆ¶æµå›¾CFG

- 4.åŸºæœ¬å—çš„å±•å¼€ï¼š

  - å¯¹å‡½æ•°ä½“ä¸­çš„æ¯ä¸ªåŸºæœ¬å—æ‰€åŒ…å«çš„Gimpleè¯­å¥åºåˆ—é€ä¸ªè¿›è¡Œå±•å¼€ï¼Œè¿™æ˜¯RTLç”Ÿæˆçš„ä¸»è¦éƒ¨åˆ†ï¼Œé‡‡ç”¨çš„å½¢å¼ä¸ºï¼š

  ```c
  FOR_BB_BETWEEN (bb, init_block->next_bb, EXIT_BLOCK_PTR, next_bb )
      bb = expand_gimple_basic_block (bb);
  ```

  - å³å¯¹å‡½æ•°åˆå§‹å—ä¹‹åçš„æ¯ä¸ªåŸºæœ¬å—é€ä¸€è¿›è¡Œå±•å¼€

- 5.é€€å‡ºå—çš„å¤„ç†ï¼š

  - è°ƒç”¨`construct_exit_block(void)`å‡½æ•°ï¼Œ**åˆ›å»ºé€€å‡ºå—**
  - ç”Ÿæˆå‡½æ•°é€€å‡ºæ—¶çš„RTLï¼Œå¹¶ä¿®æ­£å‡½æ•°çš„æ§åˆ¶æµå›¾CFG

- 6.å…¶ä»–å¤„ç†



#### 10.3.1.å˜é‡å±•å¼€

```c
int global_int = 0;
int gimple2rtl(int a, short b, char * p)
{
        int i;
        static int static_sum;
        int array[2]={0, 1};
        static_sum=a;
        for(i=global_int; i<b; i++)
        {
                int j=*p;
                static_sum=static_sum+j+array[i];
                if(static_sum>1000) goto Label_RET;
        }
        Label_RET:
                return static_sum;
}
```

- æˆ‘çš„æµ‹è¯•
- é€‰é¡¹æ˜¯`-fdump-tree-all`

```bash
gcc -c gimple2rtl.c -fdump-tree-all
```

- ç”Ÿæˆäº†ä¸‹é¢çš„

```bash
-rw-rw-r--  1 huwei huwei  292 Nov  2 07:43 gimple2rtl.c
-rw-rw-r--  1 huwei huwei  635 Nov  2 07:44 gimple2rtl.c.004t.original
-rw-rw-r--  1 huwei huwei  947 Nov  2 07:44 gimple2rtl.c.005t.gimple
-rw-rw-r--  1 huwei huwei 1044 Nov  2 07:44 gimple2rtl.c.007t.omplower
-rw-rw-r--  1 huwei huwei  990 Nov  2 07:44 gimple2rtl.c.008t.lower
-rw-rw-r--  1 huwei huwei  867 Nov  2 07:44 gimple2rtl.c.011t.eh
-rw-rw-r--  1 huwei huwei 1202 Nov  2 07:44 gimple2rtl.c.012t.cfg
-rw-rw-r--  1 huwei huwei  880 Nov  2 07:44 gimple2rtl.c.013t.ompexp
-rw-rw-r--  1 huwei huwei  880 Nov  2 07:44 gimple2rtl.c.014t.printf-return-value1
-rw-rw-r--  1 huwei huwei  880 Nov  2 07:44 gimple2rtl.c.018t.fixup_cfg1
-rw-rw-r--  1 huwei huwei 1052 Nov  2 07:44 gimple2rtl.c.019t.ssa
-rw-rw-r--  1 huwei huwei 1052 Nov  2 07:44 gimple2rtl.c.023t.fixup_cfg2
-rw-rw-r--  1 huwei huwei 1373 Nov  2 07:44 gimple2rtl.c.024t.local-fnsummary1
-rw-rw-r--  1 huwei huwei 1052 Nov  2 07:44 gimple2rtl.c.025t.einline
-rw-rw-r--  1 huwei huwei    0 Nov  2 07:44 gimple2rtl.c.043t.profile_estimate
-rw-rw-r--  1 huwei huwei 1093 Nov  2 07:44 gimple2rtl.c.046t.release_ssa
-rw-rw-r--  1 huwei huwei 1373 Nov  2 07:44 gimple2rtl.c.047t.local-fnsummary2
-rw-rw-r--  1 huwei huwei 1052 Nov  2 07:44 gimple2rtl.c.085t.fixup_cfg3
-rw-rw-r--  1 huwei huwei 1052 Nov  2 07:44 gimple2rtl.c.221t.veclower
-rw-rw-r--  1 huwei huwei 1052 Nov  2 07:44 gimple2rtl.c.222t.cplxlower0
-rw-rw-r--  1 huwei huwei 1052 Nov  2 07:44 gimple2rtl.c.224t.switchlower_O0
-rw-rw-r--  1 huwei huwei 1052 Nov  2 07:44 gimple2rtl.c.231t.optimized
-rw-rw-r--  1 huwei huwei    0 Nov  2 07:44 gimple2rtl.c.319t.statistics
-rw-rw-r--  1 huwei huwei    0 Nov  2 07:44 gimple2rtl.c.320t.earlydebug
-rw-rw-r--  1 huwei huwei    0 Nov  2 07:44 gimple2rtl.c.321t.debug
-rw-rw-r--  1 huwei huwei 1936 Nov  2 07:44 gimple2rtl.o
```





## 11.RTLå¤„ç†åŠä¼˜åŒ–



## 12.æ”¯æŒæ–°çš„ç›®æ ‡å¤„ç†å™¨





## ğŸš€å·¥ç¨‹ç»éªŒ

### 1.ç»™ä½ çš„`peephol2`ä¼˜åŒ–æ·»åŠ æ§åˆ¶é€‰é¡¹

- å…¶å®æ·»åŠ é€‰é¡¹å°±2ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªåœ¨`common.opt`ï¼Œä¸€ä¸ªåœ¨åç«¯`[xxx].opt`
  - æ¯”å¦‚`gcc/config/riscv/riscv.opt`

> æœ¬éƒ¨åˆ†å®ç°çš„è¡¥å……èµ„æ–™

- [using the gnu compiler collection (gcc) pdf](https://gcc.gnu.org/onlinedocs/gcc.pdf)

  - å…¶ä¸­çš„3.18 [GCC Developer Options](https://gcc.gnu.org/onlinedocs/gcc/Developer-Options.html)

  - æœ¬èŠ‚ä»‹ç» **GCC å¼€å‘äººå‘˜**ä¸»è¦æ„Ÿå…´è¶£çš„å‘½ä»¤è¡Œé€‰é¡¹ï¼ŒåŒ…æ‹¬æ”¯æŒ==ç¼–è¯‘å™¨æµ‹è¯•==å’Œè°ƒæŸ¥ç¼–è¯‘å™¨é”™è¯¯å’Œç¼–è¯‘æ—¶æ€§èƒ½é—®é¢˜çš„é€‰é¡¹ã€‚
    - è¿™åŒ…æ‹¬åœ¨ç¼–è¯‘çš„å„ä¸ªç‚¹ç”Ÿæˆè°ƒè¯•è½¬å‚¨çš„é€‰é¡¹ï¼›
    - æ‰“å°å†…å­˜ä½¿ç”¨å’Œæ‰§è¡Œæ—¶é—´ç­‰ç»Ÿè®¡ä¿¡æ¯ï¼›
    - å¹¶æ‰“å°æœ‰å…³ GCC é…ç½®çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å®ƒåœ¨ä½•å¤„æœç´¢åº“ã€‚
    - å¯¹äºæ™®é€šçš„ç¼–è¯‘å’Œé“¾æ¥ä»»åŠ¡ï¼Œæ‚¨åº”è¯¥å¾ˆå°‘éœ€è¦ä½¿ç”¨è¿™äº›é€‰é¡¹ä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚






## ğŸ“å‚è€ƒèµ„æ–™

- gccæºä»£ç ä¸‹è½½ï¼š[http://mirror1.babylon.network/gcc/releases/gcc-4.4.0/gcc-4.4.0.tar.bz2ä¼ é€é—¨](http://mirror1.babylon.network/gcc/releases/gcc-4.4.0/gcc-4.4.0.tar.bz2)
- æ–°è®¾è®¡å›¢é˜Ÿï¼Œ[ç¼–è¯‘ç³»ç»Ÿé€è§†](https://book.douban.com/subject/26762311/)
- ç‹äºšåˆšï¼Œ[æ·±å…¥åˆ†æGCC](https://book.douban.com/subject/26984172/)

